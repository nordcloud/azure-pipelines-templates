# Copyright 2021-2022 Nordcloud Oy or its affiliates. All Rights Reserved.

# Version 1.0.0
# Maintainer: Tadas Kazlauskas at tadas.kazlauskas@nordcloud.com

# Parameters:
# jf_server_id: JFrog server id (default: nordcloud.jfrog.io)
# jf_npm_repo: JFrog access token (default: npm-virtual)
# jf_user: JFrog user used to access artifactory (default: pat-devops)
# jf_access_token: JFrog access token
# work_dir: pipeline stage working direcorty where .npmrc is created

# JFrog NMP usage documentation:
# https://nordcloud.atlassian.net/wiki/spaces/RND/pages/4123492446/NPM+local+environment+configuration+for+JFrog+NPM+proxy

# Example usage
# steps:
#   - task: NodeTool@0
#     inputs:
#       versionSpec: $(NODE_VERSION)
#   - template: step-setup-npm-jfrog-proxy.yml@nordcloud-templates
#     parameters:
#       jf_access_token: $(JF_ACCESS_TOKEN)
#       work_dir: ./$(ROOT_DIR)

parameters:
- name: 'jf_server_id'
  type: 'string'
  default: 'nordcloud.jfrog.io'
- name: 'jf_npm_repo'
  type: 'string'
  default: 'npm-virtual'
- name: 'jf_user'
  type: 'string'
  default: 'pat-devops'
- name: 'jf_access_token'
  type: 'string'
  default: 
- name: 'work_dir'
  type: 'string'
  default: 

steps:
  - script: |
      echo "Creating .npmrc pointing to JFrog Artifactory"
      echo "registry=https://${{ parameters.jf_server_id }}/artifactory/api/npm/${{ parameters.jf_npm_repo }}/" > .npmrc
      echo "@nordcloud:registry=https://${{ parameters.jf_server_id }}/artifactory/api/npm/${{ parameters.jf_npm_repo }}/" >> .npmrc
      echo -n "//${{ parameters.jf_server_id }}/artifactory/api/npm/${{ parameters.jf_npm_repo }}/:" >> .npmrc
      curl -u${{ parameters.jf_user }}:${{ parameters.jf_access_token }} https://${{ parameters.jf_server_id }}/artifactory/api/npm/auth >> .npmrc
      echo "email = pat-devops@nordcloud.com" >> .npmrc
    displayName: "Configure JFrog proxy for NPM"
    workingDirectory: ${{ parameters.work_dir }}
