# Version 1.0.0
# Maintainer: Tadas Kazlauskas
# You need your global variables set anyways
# Parameters:
# JF_SERVER_ID: JFrog server id (default: nordcloud.jfrog.io)
# JF_ACCESS_TOKEN: JFrog access token
# JF_NPM_REPO: JFrog virtual repository name
# JFROG_CLI_VERSION: JFrog CLI version

parameters:
- name: jf_server_id 
  default: ''
- name: jf_npm_repo 
  default: 'npm-virtual'
- name: jf_access_token 
  default: ''
- name: jf_cli_version 
  default: 2.28.1

steps:
  - task: JFrogToolsInstaller@1
    inputs:
      artifactoryConnection: "JFrog Artifactory V2"
      cliInstallationRepo: "jfrog-cli"
      installCustomVersion: true
      cliVersion: ${{ parameters.jf_cli_version }}
  - script: |
      export PATH=$PATH:/opt/hostedtoolcache/jf/${{ parameters.jf_cli_version }}/x64/
      ls -lartR /opt/hostedtoolcache/jf/
      echo 'JF_SERVER_ID: ${{ parameters.jf_server_id }}'
      jf --version
      jf c add ${{ parameters.jf_server_id }} --url=https://${{ parameters.jf_server_id }}/ --interactive=false --access-token=${{ parameters.jf_access_token }}
      jf npm-config --repo-resolve ${{ parameters.jf_npm_repo }} --server-id-resolve ${{ parameters.jf_server_id }}
      jf rt ping
      jf c show
    displayName: "Configure JFrog proxy for NPM"
